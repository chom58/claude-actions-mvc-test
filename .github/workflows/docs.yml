name: Documentation Generation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å±¥æ­´å…¨ä½“ã‚’å–å¾—ï¼ˆchangelogç”Ÿæˆã®ãŸã‚ï¼‰
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Generate API documentation
      run: npm run docs:api
    
    - name: Generate code documentation
      run: npm run docs:code
    
    - name: Generate diagrams
      run: npm run docs:diagrams
    
    - name: Generate environment documentation
      run: npm run docs:env
    
    - name: Generate changelog
      run: npm run docs:changelog
    
    - name: Generate markdown documentation
      run: node scripts/generate-docs.js
    
    - name: Build Docusaurus site
      run: npm run docs:build
    
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: |
          docs/
          build/
          CHANGELOG.md
          README.md
        retention-days: 30
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build
        destination_dir: docs
    
    - name: Comment PR with documentation preview
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
          let stats = '';
          try {
            const apiDocs = fs.readFileSync('docs/api/README.md', 'utf8');
            const apiCount = (apiDocs.match(/### /g) || []).length;
            
            const diagrams = fs.readdirSync('docs/diagrams/').filter(f => f.endsWith('.md')).length;
            
            stats = `
          ## ğŸ“Š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆçµ±è¨ˆ
          
          - **APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: ${apiCount}å€‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
          - **ç”Ÿæˆã•ã‚ŒãŸå›³è¡¨**: ${diagrams}å€‹ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
          - **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ã‚¸**: [ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ğŸ“š **ç”Ÿæˆã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
          - APIä»•æ§˜ (OpenAPI/Swagger)
          - ã‚³ãƒ¼ãƒ‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (JSDoc)
          - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ (PlantUML/Mermaid)
          - ç’°å¢ƒå¤‰æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - å¤‰æ›´å±¥æ­´
          `;
          } catch (error) {
            stats = 'ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ¤– è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆå®Œäº†
          
          ã“ã®PRã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          
          ${stats}
          
          ğŸ“‹ **ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**:
          - [ ] APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’ç¢ºèª
          - [ ] æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒé©åˆ‡ã«æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹
          - [ ] ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ãŒæœ€æ–°çŠ¶æ…‹ã‚’åæ˜ ã—ã¦ã„ã‚‹
          - [ ] ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹
          
          ---
          
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚*`
          });

  lint-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check documentation links
      run: |
        # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
        find docs/ -name "*.md" -exec echo "Checking {}" \; -exec grep -H "](.*)" {} \; || true
    
    - name: Validate API documentation
      run: |
        # APIä»•æ§˜ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
        node -e "
          try {
            const { specs } = require('./src/config/swagger');
            console.log('âœ… APIä»•æ§˜ã¯æœ‰åŠ¹ã§ã™');
            console.log('ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ•°:', Object.keys(specs.paths || {}).length);
          } catch (error) {
            console.error('âŒ APIä»•æ§˜ãŒç„¡åŠ¹ã§ã™:', error.message);
            process.exit(1);
          }
        "
    
    - name: Check for documentation TODOs
      run: |
        # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®TODOã‚„FIXMEã‚’ãƒã‚§ãƒƒã‚¯
        echo "ğŸ” ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®TODO/FIXMEã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        find docs/ -name "*.md" -exec grep -Hn "TODO\|FIXME\|XXX" {} \; || echo "âœ… TODOã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"