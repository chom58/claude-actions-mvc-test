# テンプレートエンジン パフォーマンス比較

## 概要
このドキュメントでは、MVCアプリケーションで利用可能な4つのテンプレートエンジンのパフォーマンスと特徴を比較します。

## 対応テンプレートエンジン

### 1. EJS (Embedded JavaScript)
- **構文**: HTMLに埋め込みJavaScript (`<% %>`)
- **特徴**: 
  - シンプルで習得しやすい
  - JavaScriptそのものを使用可能
  - Express.jsでデフォルト対応
- **適用場面**: 小〜中規模プロジェクト、JavaScript開発者が多いチーム
- **ファイル拡張子**: `.ejs`

### 2. Pug (旧Jade)
- **構文**: インデントベース、HTMLタグ不要
- **特徴**:
  - 簡潔で読みやすい構文
  - ミックスイン、継承機能
  - 強力な条件分岐・ループ
- **適用場面**: 大規模プロジェクト、構造化されたテンプレートが必要
- **ファイル拡張子**: `.pug`

### 3. Handlebars
- **構文**: ロジックレステンプレート (`{{ }}`)
- **特徴**:
  - ビジネスロジックとプレゼンテーションの完全分離
  - 豊富なヘルパー関数
  - プリコンパイル対応
- **適用場面**: 複雑なUI、デザイナーとの協業が多い場合
- **ファイル拡張子**: `.hbs`

### 4. Nunjucks
- **構文**: Jinja2風（`{% %}`, `{{ }}`）
- **特徴**:
  - 強力なマクロ機能
  - 自動エスケープ機能
  - 豊富なフィルター
- **適用場面**: 複雑なテンプレート処理、Python経験者が多いチーム
- **ファイル拡張子**: `.njk`

## パフォーマンス比較

### レンダリング速度（参考値）
以下は1000件のアイテムを含むテンプレートのレンダリング時間の目安です：

| エンジン | 平均レンダリング時間 | メモリ使用量 | キャッシュ効果 |
|----------|---------------------|--------------|----------------|
| EJS      | 15-25ms            | 中           | 高             |
| Pug      | 10-20ms            | 低           | 高             |
| Handlebars | 20-30ms          | 中           | 高             |
| Nunjucks | 18-28ms            | 中           | 中             |

*注: 実際のパフォーマンスは使用するテンプレートの複雑さ、データ量、サーバー環境によって大きく異なります。*

### パフォーマンステスト実行方法

アプリケーション起動後、以下のエンドポイントでパフォーマンステストを実行できます：

```bash
# 現在のテンプレートエンジンでパフォーマンステスト
curl http://localhost:3000/api/performance-test
```

## 使い分けガイド

### プロジェクト規模別推奨

#### 小規模プロジェクト（～10ページ）
- **推奨**: EJS
- **理由**: シンプル、学習コストが低い

#### 中規模プロジェクト（10-50ページ）
- **推奨**: Pug または Handlebars
- **理由**: 構造化されたテンプレート、再利用性

#### 大規模プロジェクト（50ページ以上）
- **推奨**: Handlebars または Nunjucks
- **理由**: 保守性、チーム開発での分業

### チーム構成別推奨

#### JavaScript中心のチーム
- **推奨**: EJS, Pug
- **理由**: 既存知識の活用

#### デザイナー協業が多い
- **推奨**: Handlebars
- **理由**: ロジックレス、HTMLに近い構文

#### Python経験者が多い
- **推奨**: Nunjucks
- **理由**: Jinja2風の親しみやすい構文

## 設定方法

### 環境変数による切り替え

`.env`ファイルで`TEMPLATE_ENGINE`を設定：

```bash
# EJSを使用
TEMPLATE_ENGINE=ejs

# Pugを使用
TEMPLATE_ENGINE=pug

# Handlebarsを使用
TEMPLATE_ENGINE=handlebars

# Nunjucksを使用
TEMPLATE_ENGINE=nunjucks
```

### 対応するビューディレクトリ

```
views/
├── ejs/          # EJSテンプレート
├── pug/          # Pugテンプレート
├── handlebars/   # Handlebarsテンプレート
│   ├── layouts/  # レイアウトファイル
│   └── partials/ # パーシャルファイル
└── nunjucks/     # Nunjucksテンプレート
```

## ベストプラクティス

### 共通
1. **キャッシュの活用**: 本番環境では必ずキャッシュを有効化
2. **セキュリティ**: 自動エスケープ機能の活用
3. **パフォーマンス**: 複雑なロジックはコントローラー側で処理

### エンジン別
- **EJS**: インクルード機能を活用した部品化
- **Pug**: ミックスインで再利用可能なコンポーネント作成
- **Handlebars**: ヘルパー関数で表示ロジックを整理
- **Nunjucks**: マクロ機能で複雑なUI部品を作成

## トラブルシューティング

### よくある問題

1. **テンプレートが見つからない**
   - ビューディレクトリのパスを確認
   - ファイル拡張子の確認

2. **ヘルパー関数が動作しない**
   - Handlebarsの場合、ヘルパー関数の登録確認
   - 関数名のスペルミス確認

3. **パフォーマンスが遅い**
   - キャッシュ設定の確認
   - テンプレートの複雑さを見直し

### デバッグ方法

```javascript
// テンプレートエンジン情報の確認
curl http://localhost:3000/api/template-info

// パフォーマンステスト
curl http://localhost:3000/api/performance-test
```

## まとめ

各テンプレートエンジンにはそれぞれ特徴があり、プロジェクトの要件やチーム構成に応じて選択することが重要です。この機能により、同一アプリケーション内で複数のテンプレートエンジンを比較検討することが可能になります。